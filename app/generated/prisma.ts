
import { 
  UserRole, 
  OrderStatus, 
  User, 
  Client, 
  WorkOrder, 
  ServiceReport, 
  Company,
  WorkTimeEntry 
} from '../types.ts';

// Mocking the Prisma Client for browser runtime demonstration
// In a real environment, this file is auto-generated by Prisma.
export class PrismaClient {
  private getStorage<T>(key: string): T[] {
    const data = localStorage.getItem(`servicelog_${key}`);
    return data ? JSON.parse(data) : [];
  }

  private setStorage<T>(key: string, data: T[]): void {
    localStorage.setItem(`servicelog_${key}`, JSON.stringify(data));
  }

  // Generic CRUD helpers
  private db = {
    company: {
      findFirst: async () => this.getStorage<Company>('company')[0],
      create: async ({ data }: any) => {
        const list = this.getStorage<Company>('company');
        const newItem = { ...data, id: Math.random().toString(36).substr(2, 9), createdAt: new Date() };
        list.push(newItem);
        this.setStorage('company', list);
        return newItem;
      }
    },
    user: {
      findUnique: async ({ where }: any) => this.getStorage<User>('user').find(u => u.email === where.email),
      findMany: async () => this.getStorage<User>('user'),
      create: async ({ data }: any) => {
        const list = this.getStorage<User>('user');
        const newItem = { ...data, id: Math.random().toString(36).substr(2, 9), createdAt: new Date() };
        list.push(newItem);
        this.setStorage('user', list);
        return newItem;
      }
    },
    client: {
      findMany: async () => this.getStorage<Client>('client'),
      create: async ({ data }: any) => {
        const list = this.getStorage<Client>('client');
        const newItem = { ...data, id: Math.random().toString(36).substr(2, 9), createdAt: new Date() };
        list.push(newItem);
        this.setStorage('client', list);
        return newItem;
      },
      delete: async ({ where }: any) => {
        const list = this.getStorage<Client>('client').filter(c => c.id !== where.id);
        this.setStorage('client', list);
      }
    },
    workOrder: {
      findMany: async ({ include }: any) => {
        const orders = this.getStorage<WorkOrder>('workOrder');
        const clients = this.getStorage<Client>('client');
        return orders.map(o => ({
          ...o,
          client: clients.find(c => c.id === o.clientId)
        }));
      },
      create: async ({ data }: any) => {
        const list = this.getStorage<WorkOrder>('workOrder');
        const newItem = { ...data, id: Math.random().toString(36).substr(2, 9), createdAt: new Date() };
        list.push(newItem);
        this.setStorage('workOrder', list);
        return newItem;
      },
      update: async ({ where, data }: any) => {
        const list = this.getStorage<WorkOrder>('workOrder');
        const index = list.findIndex(o => o.id === where.id);
        if (index !== -1) {
          list[index] = { ...list[index], ...data };
          this.setStorage('workOrder', list);
        }
        return list[index];
      }
    },
    serviceReport: {
      findMany: async () => this.getStorage<ServiceReport>('serviceReport'),
      create: async ({ data }: any) => {
        const list = this.getStorage<ServiceReport>('serviceReport');
        const newItem = { ...data, id: Math.random().toString(36).substr(2, 9), completedAt: new Date() };
        list.push(newItem);
        this.setStorage('serviceReport', list);
        return newItem;
      }
    }
  };

  get company() { return this.db.company; }
  get user() { return this.db.user; }
  get client() { return this.db.client; }
  get workOrder() { return this.db.workOrder; }
  get serviceReport() { return this.db.serviceReport; }

  async $connect() { console.log('Mock Prisma Connected'); }
  async $disconnect() { console.log('Mock Prisma Disconnected'); }
}
